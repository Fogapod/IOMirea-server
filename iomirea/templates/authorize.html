<!DOCTYPE html>
<meta charset="utf-8" />
<html>
	<head>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
		<script language="javascript" type="text/javascript">
     		$(function() {
			var redirect_uri = "{{ redirect_uri }}"
			var app_name = "{{ app_name }}"
			var scope = "{{ scope }}"
			var state = "{{ state }}"

			var xhr = new XMLHttpRequest();

			xhr.onreadystatechange = function() {
				if (this.readyState !== XMLHttpRequest.DONE) {
					return
				}

				if (this.status === 401) {
					alert('Wrong login or password')
				} else if (this.status === 200) {
					var delim

					if (redirect_uri.includes("?")) {
						delim = "&"
					} else {
						delim = "?"
					}

					var redirect = redirect_uri+delim+'code='+this.response
					if (!(redirect.startsWith('http://') || redirect.startsWith('https://'))) {
						redirect = '//' + redirect
					}
					if (state !== '') {
						redirect += '&state='+state
					}

					window.location.assign(redirect)
				} else {
					alert('Something went terribly wrong. Please, try to refresh page or return back later')
				}
			}

			$('#auth_form').on('submit', function(e) {
				// TODO: let user modify scope
				xhr.open('POST', window.location.href, true)
	                        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
				xhr.send('login='+$('#login_field').val()+'&password='+$('#password_field').val())
			})
		});
		</script>
	</head>
	<body>
		<form id="auth_form" onsubmit="return false;">
			Scope: {{ scope }}<br>
			App Name: {{ app_name }}<br>
			Login<br>
			<input type="text" id="login_field" name="login"><br>
			Password<br>
			<input type="text" id="password_field" name="password"><br><br>
			<input type="submit" value="login">
		</form>
</body>
</html>
